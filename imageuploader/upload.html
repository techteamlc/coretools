<html>
    <head>
        <meta charset="UTF-8">
        <title>Image Uploader</title>
        <link href="https://fonts.googleapis.com/css2?family=Dosis&display=swap" rel="stylesheet">
        <link rel="stylesheet" href="./css/style.css">
    </head>
    <body class="no-auth">
        <div id="content">
            <h1>ImageUploader V2 <small>beta</small></h1>
            <div class="row">
                <div class="col col-form">
                    <form id="formUpload" enctype="multipart/form-data">
                        <input type="hidden" name="tentant" value="" />
                        <input type="hidden" name="user" value="" />
                        <input type="hidden" name="pass" value="" />
                        <div class="box">
                            <strong>Campo:</strong>
                            <label>
                                <input type="radio" name="field" value="ProductID" /> ProductID <small>código do produto Linx Commerce</small>
                            </label>
                            <label>
                                <input type="radio" name="field" value="IntegrationID" /> IntegrationID
                            </label>
                            <label>
                                <input type="radio" name="field" value="SkuID" /> SkuID
                            </label>
                        </div>

                        <div class="box">
                            <strong>Separador:</strong>
                            <label>
                                <input type="radio" name="separator" value="_" /> underline <small>ex.: 903123_1.jpg</small>
                            </label>
                            <label>
                                <input type="radio" name="separator" value="-" /> hífen <small>ex.: 903123-1.jpg</small>
                            </label>
                            <label>
                                <input type="radio" name="separator" value="|" /> Pipe <small>ex.: 903123|1.jpg</small>
                            </label>
                            <label>
                                <input type="radio" name="separator" value="" /> sem separador <small>ex.: 903123.jpg</small>
                            </label>
                        </div>
                        <div class="box">
                            <strong>Configurações</strong>
                            <label for="">
                                <input type="checkbox" name="keep" value="true"> Manter apenas a media enviada
                            </label>
                            <label for="">
                                <input type="checkbox" name="replace" value="true"> Substiuir a imagem caso a mesma já exista
                            </label>
                        </div>

                        <div class="box">
                            <strong>Imagens:</strong>
                            <input type="file" id="upload" multiple/>
                        </div>
                        <!--<img id="img" style="width: 100px" />-->
                        <div>
                            <button>Enviar</button>
                        </div>
                    </form>
                </div>
                <div class="col col-photos">
                    <div class="box box-photos">
                        <strong>Lista de imagens para upload</strong>
                        <div id="photos">
                            <small class="empty">selecione as imagens que deseja fazer o upload</small>
                        </div>
                        <!--
                        <div class="total hide">
                            <em></em> fotos
                        </div>
                        -->
                        <div class="progress hide">
                            enviando <em class="from"></em> de <em class="to"></em>
                        </div>
                    </div>
                    <div class="box box-callback">
                        <strong>Mensagens</strong>
                        <div id="callback">
                            <small class="empty">...</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="login" class="box">
            <form action="" id="formLogin">
                <div class="input-wrapper">
                    <input type="text" name="login" placeholder="Informe o usuário">
                </div>
                <div class="input-wrapper">
                    <input type="password" name="pass" placeholder="Informe a senha">
                </div>
                <small class="callback"></small>
                <div class="button-wrapper">
                    <button>Acessar</button>
                    <span class="spinner"></span>
                </div>
            </form>
        </div>

        <script type="text/javascript" src="https://code.jquery.com/jquery-3.2.1.min.js"></script>        
        <script>
            var slugify = function(text) {
                return text
                    .toLowerCase()
                    .replace(/ /g,'-')
                    .replace(/[^\w-]+/g,'');
            };
            
            $(function() {
                $('#upload').change(function() {
                    $('#photos').empty();
                    let files = $('#upload')[0].files;
                    $.each(files, function(k, i) {
                        let file = files[k];
                        $('#photos').append(`<div class="${slugify(i.name)}"><span class="spinner"></span>${i.name}</div>`);
                    });
                    //$('.box-photos .total em').text(files.length);
                    //$('.box-photos .total').show();
                });

                $('#formUpload').on('submit', function(e) {
                    e.preventDefault();
                    $('#callback').empty();
                    $('#photos > div').removeClass('success error');

                    $('.box-photos .progress .from').text('1');
                    $('.box-photos .progress .to').text($('#photos > div').length);
                    $('.box-photos .progress').show();
                   
                    let files = $('#upload')[0].files,
                        keep = $('[name="keep"]:checked').val(),
                        replace = $('[name="replace"]:checked').val(),
                        field = $('[name="field"]:checked').val();
                        separator = $('[name="separator"]:checked').val();

                    let data = $(this).serialize();
                        
                    $.each(files, function(k, i) {

                        const fileReader = new FileReader();                        

                        let file = files[k];

                        fileReader.onloadend = function(){
                            let name = slugify(i.name);

                            $.ajax({
                                url: './sendupload.php',
                                type: 'post',
                                data: {
                                    user: localStorage.getItem('_imgup_u'),
                                    pass: localStorage.getItem('_imgup_p'),
                                    field: field,
                                    separator: separator,
                                    replace: replace,
                                    keep: keep,
                                    name: name,
                                    type: i.type,
                                    size: i.size,
                                    base64: fileReader.result
                                },
                                beforeSend: () => {
                                    $(`div.${name}`).addClass('loading');
                                }
                            }).done( (response) => {
                                if (response.hasOwnProperty('APIresponseSuccess')) {
                                    if (response.APIresponseSuccess) {
                                        $(`div.${response.Name}`).addClass('success');
                                    } else {
                                        $(`div.${response.Name}`).addClass('error');
                                        $('#callback').append(`<div>Erro na imagem ${response.Filename}</div>`);
                                    }
                                } else {
                                    $('#callback').append(`<div>Erro na imagem ${name}</div>`);
                                }
                            }).fail( (error) => {
                                $(`div.${name}`).addClass('error');
                                $('#callback').append(`<div>Erro na imagem ${name}</div>`);
                            }).always( () => {
                                $(`div.${name}`).removeClass('loading');
                                $('.box-photos .progress .from').text($('#photos > div.error,#photos > div.success').length);
                            });
                        }
                        fileReader.readAsDataURL(file)
                    });
                });
            
                $('#formLogin').on('submit', function(e) {
                    e.preventDefault();
                    let data = $(this).serialize();
                    $.ajax({
                        url: './checkcredential.php',
                        type: 'post',
                        data: data,
                        beforeSend: () => {
                            $('#login').addClass('loading');
                        }
                    }).done( (response) => {
                        if (response.response != null) {
                            if (response.response.IsValid) {
                                localStorage.setItem('_imgup_u', $('#formLogin [name="login"]').val());
                                localStorage.setItem('_imgup_p', $('#formLogin [name="pass"]').val());
                                $('#login').fadeOut( () => {
                                    $('body').removeClass('no-auth');
                                });
                            }
                        } else {
                            $('#login').addClass('shake');
                            $('#login .callback').html('Dados inválidos!');
                            setTimeout( () => {
                                $('#login').removeClass('shake');
                            }, 300);
                            setTimeout( () => {
                                $('#login .callback').empty();
                            }, 3000);
                        }
                    }).fail( (error) => {
                        console.log('error', error);
                    }).always( () => {
                        $('#login').removeClass('loading');
                    });
                });
            });
        </script>
    </body>
</html>